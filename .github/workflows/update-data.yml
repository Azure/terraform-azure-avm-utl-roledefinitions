---
name: update-data

on:
  schedule:
    - cron: '15 4 * * 0'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  id-token: write

env:
  ROLE_DEFINITONS_CACHE: ./modules/cached-data/role_definitions.tf.json

jobs:
  update:
    environment: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version: 'stable'

      - name: install jd
        run: |
          go install github.com/josephburnett/jd@v1.7.1

      - uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2.3.0
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        id: app-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}

      - name: checkout branch
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git checkout -b update${{ github.run_id }}

      - name: update role definition data
        run: |
          cp ${{ env.ROLE_DEFINITONS_CACHE }} ${{ env.ROLE_DEFINITONS_CACHE }}.original
          az rest --method GET --uri /subscriptions/${{ vars.AZURE_SUBSCRIPTION_ID }}/providers/Microsoft.Authorization/roleDefinitions?api-version=2022-04-01 \
            | jq '{ "locals": { "role_definitions_cached": {"value": ( .value | map(select(.properties.type == "BuiltInRole")) ) }}}' \
            > ${{ env.ROLE_DEFINITONS_CACHE }}
        working-directory: ${{ github.workspace }}

      - name: deep compare role definition data
        run: |
          if ! jd -set ${{ env.ROLE_DEFINITONS_CACHE }}.original ${{ env.ROLE_DEFINITONS_CACHE }}; then
            echo "${{ env.ROLE_DEFINITONS_CACHE }} has changed"
            git add ${{ env.ROLE_DEFINITONS_CACHE }}
            echo UPDATED=1 >> "$GITHUB_ENV"
          fi
        working-directory: ${{ github.workspace }}

      - name: run pre-commit
        id: precommit
        if: env.UPDATED == '1'
        run: |
          ./avm pre-commit
          if [[ -n $(git status -suno) ]]; then
            git add .
          fi
        env:

          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
      - name: commit changes & create PR
        id: pr
        if: env.UPDATED == '1'
        run: |
          if [[ -n $(git status -suno) ]]; then
            git commit -m "feat: update data from Azure"
            git push origin update${{ github.run_id }}
            PR_URL=$(gh pr create --title "feat: update data from Azure" --body "Updated from GH run id: ${{ github.run_id }}" --base main --head update${{ github.run_id }})
            echo pull-request-number=$(gh pr view $PR_URL --json number | jq -r '.number') >> "$GITHUB_OUTPUT"
          fi
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: close and comment out of date prs
        if: env.UPDATED == '1'
        run: |
          PULL_REQUESTS=$(gh pr list --search "feat: update data from Azure" --json number,headRefName)
          echo "$PULL_REQUESTS" | jq -r '.[] | select(.number != ${{ steps.pr.outputs.pull-request-number }}) | .number' | xargs -I {} gh pr close {} --delete-branch --comment "Supersceeded by #${{ steps.pr.outputs.pull-request-number }}"
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
